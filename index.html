<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å–ä¸€å£å’•åš•å’•åš•ğŸ§‹</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F2EDE4; }
        .calendar-grid div { min-height: 50px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- âš ï¸ æ³¨æ„ï¼šè«‹åœ¨æ­¤è™•æ›¿æ›æˆä½ è‡ªå·±çš„ Firebase é…ç½® ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            window.fb = { auth, db, doc, setDoc, onSnapshot };
        } catch (e) {
            console.error("Firebase åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥é…ç½®", e);
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const App = () => {
            const [view, setView] = useState('calendar');
            const [currentMonth, setCurrentMonth] = useState(new Date(2026, 0, 1));
            const [selectedDate, setSelectedDate] = useState(null);
            const [records, setRecords] = useState({});
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [user, setUser] = useState(null);
            const [isSynced, setIsSynced] = useState(false);

            const iceOptions = ['æ­£å¸¸', 'å°‘å†°', 'å¾®å†°', 'å»å†°', 'å¸¸æº«', 'æº«', 'å›ºå®š'];
            const sugarOptions = ['å…¨ç³–', 'å°‘ç³–', 'åŠç³–', 'å¾®ç³–', 'ä¸€åˆ†ç³–', 'ç„¡ç³–', 'å›ºå®š'];
            const emptyRecord = { shop: '', item: '', price: '', ice: 'å¾®å†°', sugar: 'ç„¡ç³–' };

            useEffect(() => {
                const checkFB = setInterval(() => {
                    if (window.fb) {
                        clearInterval(checkFB);
                        const { auth, onAuthStateChanged, signInAnonymously } = window.fb;
                        signInAnonymously(auth).catch(console.error);
                        onAuthStateChanged(auth, setUser);
                    }
                }, 500);
                return () => clearInterval(checkFB);
            }, []);

            useEffect(() => {
                if (!user || !window.fb) return;
                const { db, doc, onSnapshot } = window.fb;
                const docRef = doc(db, 'users', user.uid, 'data', 'records');
                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        setRecords(docSnap.data().data || {});
                    }
                    setIsSynced(true);
                }, (err) => {
                    console.error("è®€å–å¤±æ•—:", err);
                    setIsSynced(false);
                });
                return () => unsubscribe();
            }, [user]);

            const saveToCloud = async (newRecords) => {
                if (!user || !window.fb) return;
                setIsSynced(false);
                const { db, doc, setDoc } = window.fb;
                try {
                    const docRef = doc(db, 'users', user.uid, 'data', 'records');
                    await setDoc(docRef, { data: newRecords }, { merge: true });
                    setIsSynced(true);
                } catch (e) { console.error(e); }
            };

            const formatDate = (date) => {
                const y = date.getFullYear();
                const m = String(date.getMonth() + 1).padStart(2, '0');
                const d = String(date.getDate()).padStart(2, '0');
                return `${y}-${m}-${d}`;
            };

            const monthStats = useMemo(() => {
                let totalCups = 0; let totalAmount = 0;
                const prefix = `${currentMonth.getFullYear()}-${String(currentMonth.getMonth() + 1).padStart(2, '0')}`;
                const monthlyItems = [];
                Object.keys(records).forEach(date => {
                    if (date.startsWith(prefix)) {
                        records[date].forEach(cup => {
                            totalCups++;
                            totalAmount += parseFloat(cup.price) || 0;
                            monthlyItems.push({ ...cup, date });
                        });
                    }
                });
                return { totalCups, totalAmount, monthlyItems };
            }, [records, currentMonth]);

            const updateRecord = (index, field, value) => {
                const current = [...(records[selectedDate] || [])];
                if (!current[index]) current[index] = { ...emptyRecord };
                current[index][field] = value;
                const updated = { ...records, [selectedDate]: current };
                setRecords(updated);
                saveToCloud(updated);
            };

            const addCup = () => {
                const current = [...(records[selectedDate] || [])];
                if (current.length < 2) {
                    current.push({ ...emptyRecord });
                    const updated = { ...records, [selectedDate]: current };
                    setRecords(updated);
                    saveToCloud(updated);
                }
            };

            const removeCup = (index) => {
                const current = [...(records[selectedDate] || [])];
                current.splice(index, 1);
                const updated = { ...records, [selectedDate]: current };
                setRecords(updated);
                saveToCloud(updated);
            };

            useEffect(() => { if (window.lucide) window.lucide.createIcons(); });

            return (
                <div className="min-h-screen p-4 pb-24 text-[#5D5D5D]">
                    <div className="max-w-md mx-auto space-y-4">
                        {/* çµ±è¨ˆé¢æ¿ */}
                        <div className="grid grid-cols-2 gap-3">
                            <div className="bg-white p-4 rounded-2xl shadow-sm border-b-4 border-teal-200">
                                <p className="text-[10px] font-bold text-gray-400">æœ¬æœˆæ¯æ•¸</p>
                                <p className="text-2xl font-black">{monthStats.totalCups} æ¯</p>
                            </div>
                            <div className="bg-white p-4 rounded-2xl shadow-sm border-b-4 border-rose-200">
                                <p className="text-[10px] font-bold text-gray-400">æœ¬æœˆèŠ±è²»</p>
                                <p className="text-2xl font-black">${monthStats.totalAmount}</p>
                            </div>
                        </div>

                        {/* ä¸»æœˆæ›†å¡ç‰‡ */}
                        <div className="bg-white rounded-[2.5rem] shadow-xl overflow-hidden border border-white">
                            <div className="p-6 flex flex-col items-center">
                                <h1 className="text-xl font-black">å–ä¸€å£å’•åš•å’•åš•ğŸ§‹</h1>
                                <div className="text-[10px] mt-1 flex items-center gap-1">
                                    {isSynced ? 
                                        <span className="text-teal-400 flex items-center gap-1">â— é›²ç«¯å·²åŒæ­¥</span> : 
                                        <span className="text-rose-300 flex items-center gap-1">â—‹ é€£ç·šä¸­...</span>
                                    }
                                </div>
                            </div>
                            
                            <div className="px-4 pb-6">
                                <div className="flex justify-between items-center mb-4 px-2 text-sm font-bold">
                                    <button onClick={() => setCurrentMonth(new Date(currentMonth.setMonth(currentMonth.getMonth()-1)))}>ã€ˆ</button>
                                    <span>{currentMonth.getFullYear()} / {currentMonth.getMonth() + 1}æœˆ</span>
                                    <button onClick={() => setCurrentMonth(new Date(currentMonth.setMonth(currentMonth.getMonth()+1)))}>ã€‰</button>
                                </div>
                                <div className="grid grid-cols-7 text-center text-[10px] font-black text-gray-300 mb-2">
                                    {['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'].map(d => <div key={d}>{d}</div>)}
                                </div>
                                <div className="grid grid-cols-7 calendar-grid">
                                    {(() => {
                                        const year = currentMonth.getFullYear();
                                        const month = currentMonth.getMonth();
                                        const firstDay = new Date(year, month, 1).getDay();
                                        const daysInMonth = new Date(year, month + 1, 0).getDate();
                                        const days = [];
                                        for (let i = 0; i < firstDay; i++) days.push(<div key={`e-${i}`} />);
                                        for (let d = 1; d <= daysInMonth; d++) {
                                            const dStr = formatDate(new Date(year, month, d));
                                            const has = records[dStr]?.length > 0;
                                            days.push(
                                                <div key={d} onClick={() => { setSelectedDate(dStr); setIsModalOpen(true); }}
                                                     className={`aspect-square border border-gray-50 p-1 flex flex-col items-center rounded-xl m-0.5 cursor-pointer hover:bg-rose-50/50 ${has ? 'bg-rose-50 ring-1 ring-rose-100' : 'bg-white'}`}>
                                                    <span className="text-[10px] font-bold text-gray-400">{d}</span>
                                                    {has && <div className="mt-auto mb-1 text-teal-400">â—</div>}
                                                </div>
                                            );
                                        }
                                        return days;
                                    })()}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* ç·¨è¼¯å½ˆçª— */}
                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-[2rem] w-full max-w-sm p-6 shadow-2xl overflow-y-auto max-h-[80vh]">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="font-black text-lg">{selectedDate} ç´€éŒ„</h2>
                                    <button onClick={() => setIsModalOpen(false)} className="p-2">âœ•</button>
                                </div>
                                
                                <div className="space-y-4">
                                    {(records[selectedDate] || []).map((cup, idx) => (
                                        <div key={idx} className="p-4 bg-gray-50 rounded-2xl relative border border-gray-100">
                                            <button onClick={() => removeCup(idx)} className="absolute top-2 right-2 text-rose-300">âœ•</button>
                                            <div className="grid grid-cols-2 gap-2 mb-3">
                                                <input type="text" placeholder="åº—å®¶" className="p-2 rounded-lg border text-sm" value={cup.shop} onChange={e => updateRecord(idx, 'shop', e.target.value)} />
                                                <input type="text" placeholder="å“é …" className="p-2 rounded-lg border text-sm" value={cup.item} onChange={e => updateRecord(idx, 'item', e.target.value)} />
                                                <input type="number" placeholder="é‡‘é¡" className="p-2 rounded-lg border text-sm col-span-2" value={cup.price} onChange={e => updateRecord(idx, 'price', e.target.value)} />
                                            </div>
                                            <div className="flex flex-wrap gap-1 mb-2">
                                                {iceOptions.map(opt => (
                                                    <button key={opt} onClick={() => updateRecord(idx, 'ice', opt)} className={`px-2 py-1 text-[10px] rounded ${cup.ice === opt ? 'bg-teal-400 text-white' : 'bg-white border text-gray-400'}`}>{opt}</button>
                                                ))}
                                            </div>
                                            <div className="flex flex-wrap gap-1">
                                                {sugarOptions.map(opt => (
                                                    <button key={opt} onClick={() => updateRecord(idx, 'sugar', opt)} className={`px-2 py-1 text-[10px] rounded ${cup.sugar === opt ? 'bg-rose-300 text-white' : 'bg-white border text-gray-400'}`}>{opt}</button>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                    
                                    {(records[selectedDate] || []).length < 2 && (
                                        <button onClick={addCup} className="w-full py-4 border-2 border-dashed border-gray-200 rounded-2xl text-gray-400 font-bold text-xs">+ æ–°å¢ç´€éŒ„</button>
                                    )}
                                </div>

                                <button onClick={() => setIsModalOpen(false)} className="w-full mt-6 bg-[#5D5D5D] text-white py-4 rounded-2xl font-black shadow-lg">å®Œæˆä¸¦å„²å­˜</button>
                            </div>
                        </div>
                    )}

                    {/* ä¸‹æ–¹å°è¦½åˆ— */}
                    <div className="fixed bottom-6 left-1/2 -translate-x-1/2 flex bg-white/90 backdrop-blur px-2 py-2 rounded-2xl shadow-xl border border-white z-40 w-64">
                        <button onClick={() => setView('calendar')} className={`flex-1 py-2 rounded-xl text-xs font-bold ${view === 'calendar' ? 'bg-teal-400 text-white shadow-md' : 'text-gray-400'}`}>æ—¥æ›†</button>
                        <button onClick={() => setView('list')} className={`flex-1 py-2 rounded-xl text-xs font-bold ${view === 'list' ? 'bg-teal-400 text-white shadow-md' : 'text-gray-400'}`}>æ¸…å–®</button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
