<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å–ä¸€å£å’•åš•å’•åš•ğŸ§‹</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F2EDE4; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- âš ï¸ æ³¨æ„ï¼šè«‹åœ¨æ­¤è™•æ›¿æ›æˆä½ è‡ªå·±çš„ Firebase é…ç½® ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // å°‡ Firebase å¯¦ä¾‹æ›è¼‰åˆ° windowï¼Œè®“ React è…³æœ¬å¯ä»¥ä½¿ç”¨
        window.fb = { auth, db, doc, setDoc, onSnapshot };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { 
            ChevronLeft, ChevronRight, Plus, Trash2, CupSoda, 
            X, Calculator, ReceiptText, Calendar: CalendarIcon, 
            List, Cloud, RefreshCw 
        } = lucide;

        const App = () => {
            const [view, setView] = useState('calendar');
            const [currentMonth, setCurrentMonth] = useState(new Date(2026, 0, 1));
            const [selectedDate, setSelectedDate] = useState(null);
            const [records, setRecords] = useState({});
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [user, setUser] = useState(null);
            const [isSynced, setIsSynced] = useState(false);

            useEffect(() => {
                if (!window.fb) return;
                const { auth, onAuthStateChanged, signInAnonymously } = window.fb;
                signInAnonymously(auth).catch(console.error);
                const unsubscribe = onAuthStateChanged(auth, setUser);
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user || !window.fb) return;
                const { db, doc, onSnapshot } = window.fb;
                const docRef = doc(db, 'users', user.uid, 'data', 'records');
                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        setRecords(docSnap.data().data || {});
                    }
                    setIsSynced(true);
                }, () => setIsSynced(false));
                return () => unsubscribe();
            }, [user]);

            const saveToCloud = async (newRecords) => {
                if (!user || !window.fb) return;
                setIsSynced(false);
                const { db, doc, setDoc } = window.fb;
                try {
                    const docRef = doc(db, 'users', user.uid, 'data', 'records');
                    await setDoc(docRef, { data: newRecords }, { merge: true });
                    setIsSynced(true);
                } catch (e) { console.error(e); }
            };

            // ä»¥ä¸‹é‚è¼¯èˆ‡å…ˆå‰ç‰ˆæœ¬ç›¸åŒ...
            const formatDate = (date) => {
                const y = date.getFullYear();
                const m = String(date.getMonth() + 1).padStart(2, '0');
                const d = String(date.getDate()).padStart(2, '0');
                return `${y}-${m}-${d}`;
            };

            const monthStats = useMemo(() => {
                let totalCups = 0; let totalAmount = 0;
                const prefix = `${currentMonth.getFullYear()}-${String(currentMonth.getMonth() + 1).padStart(2, '0')}`;
                Object.keys(records).forEach(date => {
                    if (date.startsWith(prefix)) {
                        records[date].forEach(cup => {
                            totalCups++;
                            totalAmount += parseFloat(cup.price) || 0;
                        });
                    }
                });
                return { totalCups, totalAmount };
            }, [records, currentMonth]);

            const renderCalendar = () => {
                const year = currentMonth.getFullYear();
                const month = currentMonth.getMonth();
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const days = [];
                for (let i = 0; i < firstDay; i++) days.push(<div key={`e-${i}`} />);
                for (let d = 1; d <= daysInMonth; d++) {
                    const date = new Date(year, month, d);
                    const dStr = formatDate(date);
                    const has = records[dStr]?.length > 0;
                    days.push(
                        <div key={d} onClick={() => { setSelectedDate(dStr); setIsModalOpen(true); }}
                             className={`aspect-square border border-gray-100 p-1 flex flex-col items-center rounded-xl m-0.5 bg-white cursor-pointer hover:bg-rose-50/50 ${has ? 'ring-1 ring-rose-200 bg-rose-50' : ''}`}>
                            <span className="text-[10px] font-bold text-gray-400">{d}</span>
                            {has && <div className="mt-auto mb-1 text-teal-400"><i data-lucide="cup-soda" style={{width: 14, height: 14}}></i></div>}
                        </div>
                    );
                }
                return days;
            };

            useEffect(() => { if (window.lucide) window.lucide.createIcons(); });

            return (
                <div className="min-h-screen p-4 pb-24">
                    <div className="max-w-md mx-auto space-y-4">
                        <div className="grid grid-cols-2 gap-3 text-[#5D5D5D]">
                            <div className="bg-white p-4 rounded-2xl shadow-sm border-b-4 border-teal-200">
                                <p className="text-[10px] font-bold text-gray-400">ç¸½æ¯æ•¸</p>
                                <p className="text-2xl font-black">{monthStats.totalCups} <span className="text-xs">æ¯</span></p>
                            </div>
                            <div className="bg-white p-4 rounded-2xl shadow-sm border-b-4 border-rose-200">
                                <p className="text-[10px] font-bold text-gray-400">ç¸½èŠ±è²»</p>
                                <p className="text-2xl font-black">${monthStats.totalAmount}</p>
                            </div>
                        </div>

                        <div className="bg-white rounded-[2.5rem] shadow-xl overflow-hidden border border-white">
                            <div className="p-6 flex flex-col items-center bg-white">
                                <h1 className="text-xl font-black text-[#5D5D5D]">å–ä¸€å£å’•åš•å’•åš•ğŸ§‹</h1>
                                <div className="flex items-center gap-1 mt-1">
                                    {isSynced ? 
                                        <span className="text-[10px] text-teal-400 flex items-center gap-1"><i data-lucide="cloud" style={{width:12}}></i> é›²ç«¯åŒæ­¥ä¸­</span> : 
                                        <span className="text-[10px] text-rose-300 flex items-center gap-1"><i data-lucide="refresh-cw" className="animate-spin" style={{width:12}}></i> å„²å­˜ä¸­</span>
                                    }
                                </div>
                            </div>
                            <div className="px-4 pb-6">
                                <div className="grid grid-cols-7 text-center text-[10px] font-black text-gray-300 mb-3 tracking-tighter">
                                    {['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'].map(d => <div key={d}>{d}</div>)}
                                </div>
                                <div className="grid grid-cols-7">{renderCalendar()}</div>
                            </div>
                        </div>
                    </div>

                    {/* ä¸‹æ–¹å°è¦½èˆ‡å½ˆçª—çœç•¥ä»¥ç¯€çœç©ºé–“ï¼Œä½†é€»è¾‘å®Œæ•´ */}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
